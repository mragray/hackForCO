/*
 * @author: Jeff Thompson
 * See COPYING for copyright and distribution information.
 * This is the ndn protocol handler.
 * Protocol handling code derived from http://mike.kaply.com/2011/01/18/writing-a-firefox-protocol-handler/
 *//*
 * Create a closure for calling expressInterest.
 * contentListener is from the call to requestContent.
 * uriName is the name in the URI passed to newChannel (used in part to determine whether to request 
 *   only that segment number and for updating the URL bar).
 * aURI is the URI passed to newChannel.
 * uriSearchAndHash is the search and hash part of the URI passed to newChannel, including the '?'
 *    and/or '#' but without the interest selector fields.
 * segmentTemplate is the template used in expressInterest to fetch further segments.
 * The uses ExponentialReExpressClosure in expressInterest to re-express if fetching a segment times out.
 */function getNameContentTypeAndCharset(e){var t=e.indexOfFileName();console.log(t);if(t<0)return MimeTypes.getContentTypeAndCharset("");console.log(MimeTypes.getContentTypeAndCharset(DataUtils.toString(e.components[t]).toLowerCase()));return MimeTypes.getContentTypeAndCharset(DataUtils.toString(e.components[t]).toLowerCase())}function endsWithSegmentNumber(e){return e.components!=null&&e.components.length>=1&&e.components[e.components.length-1].length>=1&&e.components[e.components.length-1][0]==0}function extractNdnSearch(e,t){if(e.length>=1&&e[0]=="?"){var n=e.substr(1).split("&"),r=0;while(r<n.length){var i=n[r].split("="),s=i[0].trim();if(s.substr(0,4)=="ndn."){if(i.length>=1){var o=i[1].trim(),u=parseInt(o);s=="ndn.MinSuffixComponents"&&u>=0?t.minSuffixComponents=u:s=="ndn.MaxSuffixComponents"&&u>=0?t.maxSuffixComponents=u:s=="ndn.ChildSelector"&&u>=0?t.childSelector=u:s=="ndn.AnswerOriginKind"&&u>=0?t.answerOriginKind=u:s=="ndn.Scope"&&u>=0?t.scope=u:s=="ndn.InterestLifetime"&&u>=0?t.interestLifetime=u:s=="ndn.PublisherPublicKeyDigest"?t.publisherPublicKeyDigest=DataUtils.toNumbersFromString(unescape(o)):s=="ndn.Nonce"?t.nonce=DataUtils.toNumbersFromString(unescape(o)):s=="ndn.Exclude"&&(t.exclude=parseExclude(o))}n.splice(r,1)}else++r}return n.length==0?"":"?"+n.join("&")}return e}function parseExclude(e){var t=[],n=e.split(",");for(var r=0;r<n.length;++r){var i=n[r].trim();i=="*"?t.push(Exclude.ANY):t.push(Name.fromEscapedString(i))}return new Exclude(t)}function getIndexOfMetaComponent(e){for(var t=0;t<e.components.length;++t){var n=e.components[t];if(n.length>=MetaComponentPrefix.length&&DataUtils.arraysEqual(n.subarray(0,MetaComponentPrefix.length),MetaComponentPrefix))return t}return-1}var ContentClosure=function(t,n,r,i){Closure.call(this);this.ndn=t;this.name=n;this.segmentTemplate=r;this.callback=i;this.segmentStore=new SegmentStore;this.contentSha256=new Sha256;this.didRequestFinalSegment=!1;this.finalSegmentNumber=null;this.didOnStart=!1;this.uriEndsWithSegmentNumber=endsWithSegmentNumber(n.to_uri());this.done=!1;this.fullcontent=""};ContentClosure.prototype.upcall=function(e,t){try{if(e==Closure.UPCALL_INTEREST_TIMED_OUT){if(!this.didOnStart){this.callback();return Closure.RESULT_OK}return Closure.RESULT_ERR}if(e!=Closure.UPCALL_CONTENT&&e!=Closure.UPCALL_CONTENT_UNVERIFIED)return Closure.RESULT_ERR;var n=t.contentObject;if(n.content==null){dump("NdnProtocol.ContentClosure: contentObject.content is null\n");return Closure.RESULT_ERR}var r=null;if(!this.uriEndsWithSegmentNumber&&endsWithSegmentNumber(n.name)){r=DataUtils.bigEndianToUnsignedInt(n.name.components[n.name.components.length-1]);this.segmentStore.storeContent(r,n)}if((r==null||r==0)&&!this.didOnStart){this.didOnStart=!0;var i;if(!this.uriEndsWithSegmentNumber&&endsWithSegmentNumber(n.name)){var s=new Name(n.name.components.slice(0,n.name.components.length-1));i=s.to_uri()}else i=n.name.to_uri();var o=getNameContentTypeAndCharset(n.name);this.contentTypeEtc=o}if(r==null){console.log("contentObject : ",n);this.fullcontent=DataUtils.toString(n.content);var u=n.name.components.slice(0,n.name.components.length),a=DataUtils.toString(u[u.length-1]),f="";for(var l=0;l<u.length-1;l++)f=f+DataUtils.toString(u[l])+"/";this.callback(this.ndn,f,n.content,a);this.contentSha256.update(n.content);if(!this.uriEndsWithSegmentNumber){var c=n.name.getContentDigestValue();c!=null&&!DataUtils.arraysEqual(c,this.contentSha256.finalize())&&console.log("Content does not match digest in name "+n.name.to_uri())}return Closure.RESULT_OK}n.signedInfo!=null&&n.signedInfo.finalBlockID!=null&&(this.finalSegmentNumber=DataUtils.bigEndianToUnsignedInt(n.signedInfo.finalBlockID));var h;while((h=this.segmentStore.maybeRetrieveNextEntry())!=null){r=h.key;n=h.value;this.fullcontent+=DataUtils.toString(n.content);this.contentSha256.update(n.content);if(this.finalSegmentNumber!=null&&r==this.finalSegmentNumber){console.log("finished");var c=n.name.getContentDigestValue();c!=null&&!DataUtils.arraysEqual(c,this.contentSha256.finalize())&&console.log("Content does not match digest in name "+n.name.to_uri());this.done=!0;var u=n.name.components.slice(0,n.name.components.length),a=DataUtils.toString(u[2]);this.callback(this.fullcontent,a);return Closure.RESULT_OK}}if(this.finalSegmentNumber==null&&!this.didRequestFinalSegment){this.didRequestFinalSegment=!0;var u=n.name.components.slice(0,n.name.components.length),p=this.segmentTemplate.clone();p.childSelector=1;this.ndn.expressInterest(new Name(u),new ExponentialReExpressClosure(this),p)}var d=this.segmentStore.requestSegmentNumbers(2);for(var l=0;l<d.length;++l){if(this.finalSegmentNumber!=null&&d[l]>this.finalSegmentNumber)continue;this.ndn.expressInterest((new Name(n.name.components.slice(0,n.name.components.length-1))).addSegment(d[l]),new ExponentialReExpressClosure(this),this.segmentTemplate)}return Closure.RESULT_OK}catch(v){console.log("ContentClosure.upcall exception: "+v+":"+v.stack);return Closure.RESULT_ERR}};var AsyncPutClosure=function(t,n,r,i){Closure.call(this);this.content=r;this.ndn=t;this.name=n;this.signed=i};AsyncPutClosure.prototype.upcall=function(e,t){console.log("started publish upcall");if(e==Closure.UPCALL_FINAL)console.log("is this where things are stopping?");else if(e==Closure.UPCALL_INTEREST){console.log("AsyncPutClosure.upcall() called.");console.log("Host: "+this.ndn.host+":"+this.ndn.port);console.log("truename",this.name);console.log(this.content);var n=t.interest;if(n.matches_name(this.name)==1){var r=this.signed;r.finalBlockID=[0];console.log("si",r);var i=new ContentObject(this.name,r,this.content,new Signature);i.sign();console.log("co",i);t.contentObject=i;return Closure.RESULT_INTEREST_CONSUMED}}return Closure.RESULT_OK};var PublishClosure=function(t){Closure.call(this);this.ndn=t};PublishClosure.prototype.upcall=function(e,t){console.log("started put upcall");if(e==Closure.UPCALL_FINAL)console.log("is this where things are stopping?");else if(e==Closure.UPCALL_INTEREST){console.log("PublishClosure.upcall() called.");console.log("Host: "+this.ndn.host+":"+this.ndn.port);var n=t.interest;console.log("upcallInfo.interest",t.interest);var r=n.name.getName();console.log("interestnamestring?",n.name.getName());var i=sdb.req(NeighborNetDBschema,function(e){i.tr(e,["pageContentObjects"],"readonly").store("pageContentObjects").index("name").get(n.name.getName(),function(e){var n=t.interest,r=n.name.getName(),i=new SignedInfo;console.log(e.signedInfo);var s=new ContentObject(new Name(r),i,e.page,new Signature);s.sign();console.log("co",Closure);t.contentObject=s;console.log("co",t.toString())})});return Closure.RESULT_INTEREST_CONSUMED}return Closure.RESULT_OK};var SegmentStore=function(){this.store=new SortedArray;this.maxRetrievedSegmentNumber=-1};SegmentStore.prototype.storeContent=function(e,t){e>this.maxRetrievedSegmentNumber&&this.store.set(e,t)};SegmentStore.prototype.maybeRetrieveNextEntry=function(){if(this.store.entries.length>0&&this.store.entries[0].value!=null&&this.store.entries[0].key==this.maxRetrievedSegmentNumber+1){var e=this.store.entries[0];this.store.removeAt(0);++this.maxRetrievedSegmentNumber;return e}return null};SegmentStore.prototype.requestSegmentNumbers=function(e){var t=0;for(var n=0;n<this.store.entries.length;++n)if(this.store.entries[n].value==null){++t;if(t>=e)return[]}var r=[],i=this.maxRetrievedSegmentNumber+1;for(var n=0;n<this.store.entries.length;++n){var s=this.store.entries[n];while(i<s.key){r.push(i);++i;++t;if(t>=e)break}if(t>=e)break;i=s.key+1}while(t<e){r.push(i);++i;++t}for(var n=0;n<r.length;++n)this.store.set(r[n],null);return r};var SortedArray=function(){this.entries=[]};SortedArray.prototype.sortEntries=function(){this.entries.sort(function(e,t){return e.key-t.key})};SortedArray.prototype.indexOfKey=function(e){for(var t=0;t<this.entries.length;++t)if(this.entries[t].key==e)return t;return-1};SortedArray.prototype.set=function(e,t){var n=this.indexOfKey(e);if(n>=0){this.entries[n].value=t;return}this.entries.push({key:e,value:t});this.sortEntries()};SortedArray.prototype.removeAt=function(e){this.entries.splice(e,1)};var MetaComponentPrefix=new Uint8Array([193,46,77,69,84,65]);