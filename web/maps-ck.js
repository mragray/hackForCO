var mapDebug;require(["esri/map","esri/geometry/Point","esri/geometry/Multipoint","esri/geometry/Polyline","esri/geometry/Polygon","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/InfoTemplate","./utils.js","dojo/_base/Color","dojo/on","dojo/dom","dojo/domReady!"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){"use strict";function C(e){var n=e.location,r=new t(n.longitude,n.latitude),i={Lat:n.latitude.toFixed(2),Lon:n.longitude.toFixed(2)},o=new f("Shout!",e.text),u=new s(r,g,i,o);d.graphics.add(u);setTimeout(function(){d.graphics.remove(u)},e.timeout*1e3)}function k(e){var t=e.split(" "),n=t[2].split(""),r=t[3].split("");return t[0]+"/"+t[1]+"/"+n[0]+r[0]+"/"+n[1]+r[1]+"/"+n[2]+r[2]+"/"+n[3]+r[3]+"/"}function A(e){var t="Nei.ghbor.Net"+e+"shoutout",n=new Name(t),r=new Interest(n),i={},s=function(t,n,r,s){if(!t){setTimeout(function(){A(e)},250);return}var u=DataUtils.toString(r);u=JSON.parse(u);console.log(n,u,s);C(u);L.push(DataUtils.toNumbersFromString(s));console.log("exclusions",L);var a=new Name(n),f=new Interest(a);i.exclude=new Exclude(L);f.exclude=i.exclude;t.expressInterest(a,o,i)},o=new ContentClosure(m,n,r,s);m.expressInterest(n,o,i)}function O(e){var t=D.split("/"),n="Nei.ghbor.Net";for(var r=0;r<6;r++){n=n+"/"+t[r];m[r]=new NDN({host:"10.18.1.118"});var i=new Name(n+"/shoutout"),s=new Name(n+"/shoutout/"+e.timestamp),o=m[r],u=new SignedInfo;u.freshnessSeconds=e.timeout;if(NDN.CSTable[r]==undefined)o.registerPrefix(i,new ShoutoutAsyncPutClosure(o,s,JSON.stringify(e),u));else{NDN.CSTable[r].closure.content=JSON.stringify(e);NDN.CSTable[r].closure.name=s}}}function B(e){M.left=e.xmin;M.right=e.xmax;M.top=e.ymax;M.bottom=e.ymin;var t=k(v.LLtoUSNG(M.top,M.left,4)).split("/"),n=k(v.LLtoUSNG(M.top,M.right,4)).split("/"),r=k(v.LLtoUSNG(M.bottom,M.left,4)).split("/"),i=k(v.LLtoUSNG(M.bottom,M.right,4)).split("/"),s=e.getCenter();H={latitude:s.y,longitude:s.x};P=v.LLtoUSNG(s.y,s.x,4);D=k(P);_="/";var o=0;while(t[o]==n[o]&&t[o]==r[o]&&t[o]==i[o]){_+=t[o]+"/";o++}A(_)}function j(e,t){var n={Lat:e.getLatitude().toFixed(2),Lon:e.getLongitude().toFixed(2)},r=new f("My Point","Latitude: ${Lat} <br/>Longitude: ${Lon}"),i=new s(e,g,n,r);d.graphics.add(i)}function F(e){if(!w){x=new n(e.spatialReference);x.addPoint(e);w=new s(x,g);d.graphics.add(w)}else{x.addPoint(e);w.setGeometry(x)}}function I(){return new o(o.STYLE_SQUARE,7,new u(u.STYLE_SOLID,new c([255,0,0]),1),new c([255,0,0,.75]))}function q(){d.infoWindow.hide();d.graphics.clear();w=null;E=null;S=null;T=null}function R(e){dojo.connect(e,"onExtentChange",function(t,n,r,i){B(e.geographicExtent)});e.on("click",function(t){e.centerAt(t.mapPoint)})}var d,v=org.mymanatee.common.usng,m=new NDN({host:"10.18.1.118"}),g,y,b,w,E,S,x,T,N;g=I();var L=[],M={top:0,right:0,bottom:0,left:0},_="/",D="/",P,H;if("geolocation"in navigator)navigator.geolocation.getCurrentPosition(function(t){var n=H=t.coords;d=mapDebug=new e("myMap",{basemap:"streets",center:[n.longitude,n.latitude],zoom:12});l.autoRecenter(d);R(d)});else{d=new e("myMap",{basemap:"streets",center:[-79.4,43.55],zoom:9});l.autoRecenter(d)}var U=jQuery("#shout").blur(function(e){var t=U.val();if(!t)return;var n={text:t,timeout:60,location:H,timestamp:(new Date).getTime()};O(n)})});