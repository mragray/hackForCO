var mapDebug;require(["esri/map","esri/geometry/Point","esri/geometry/Multipoint","esri/geometry/Polyline","esri/geometry/Polygon","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/InfoTemplate","./utils.js","dojo/_base/Color","dojo/on","dojo/dom","dojo/domReady!"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){"use strict";function T(e,n){var r=jQuery(S.replace("$TEXT",e.text)),i=e.location,s=d.toScreen(new t(i.longitude,i.latitude));r.css({zIndex:1e3+x++,left:s.x,top:s.y});jQuery(".wrap").prepend(r).find("p").slideDown();setTimeout(function(){E?E=E.add(r):E=jQuery(".shout-box-wrapper")});setTimeout(function(){E=E.not(r);r.fadeOut()},e.timeout*1e3)}function N(e){var t=e.split(" "),n=t[2].split(""),r=t[3].split("");return t[0]+"/"+t[1]+"/"+n[0]+r[0]+"/"+n[1]+r[1]+"/"+n[2]+r[2]+"/"+n[3]+r[3]+"/"}function L(e){var t="Nei.ghbor.Net"+e+"shoutout",n=new Name(t),r=new Interest(n),i={};k=function(t,n,r,o){if(!t){setTimeout(function(){L(e)},250);return}var u=DataUtils.toString(r);u=JSON.parse(u);var a=u.text+u.timestamp;if(jQuery.inArray(a,w)>-1)return;w.push(a);T(u);C.push(DataUtils.toNumbersFromString(o));var f=new Name(n),l=new Interest(f);i.exclude=new Exclude(C);l.exclude=i.exclude;t.expressInterest(f,s,i)};var s=new ContentClosure(m,n,r,k);m.expressInterest(n,s,i)}function A(e){var t=_.split("/"),n="Nei.ghbor.Net";w.push(e.text+e.timestamp);T(e,!0);for(var r=0;r<6;r++){n=n+"/"+t[r];m[r]=new NDN({host:"localhost"});var i=new Name(n+"/shoutout"),s=new Name(n+"/shoutout/"+e.timestamp),o=m[r],u=new SignedInfo;u.freshnessSeconds=e.timeout;if(NDN.CSTable[r]==undefined)o.registerPrefix(i,new AsyncPutClosure(o,s,JSON.stringify(e),u));else{NDN.CSTable[r].closure.content=JSON.stringify(e);NDN.CSTable[r].closure.name=s}}}function H(e){O.left=e.xmin;O.right=e.xmax;O.top=e.ymax;O.bottom=e.ymin;var t=N(v.LLtoUSNG(O.top,O.left,4)).split("/"),n=N(v.LLtoUSNG(O.top,O.right,4)).split("/"),r=N(v.LLtoUSNG(O.bottom,O.left,4)).split("/"),i=N(v.LLtoUSNG(O.bottom,O.right,4)).split("/"),s=e.getCenter();P={latitude:s.y,longitude:s.x};D=v.LLtoUSNG(s.y,s.x,4);_=N(D);M="/";var o=0;while(t[o]==n[o]&&t[o]==r[o]&&t[o]==i[o]){M+=t[o]+"/";o++}L(M)}function B(e,t){var n={Lat:e.getLatitude().toFixed(2),Lon:e.getLongitude().toFixed(2)},r=new f("My Point","Latitude: ${Lat} <br/>Longitude: ${Lon}"),i=new s(e,pointSymbol,n,r);d.graphics.add(i)}function F(e){h(e,"extent-change",function(t,n,r,i){H(e.geographicExtent)});h(e,"pan",function(e){if(!E)return;var t=e.delta;I(t.x-j.x,t.y-j.y);j=t});h(e,"pan-end",function(){j={x:0,y:0};U()});var t;h(e,"zoom-start",function(e){t=e.extent;q()});h(e,"zoom-end",function(e){R(t,e.extent,e.zoomFactor,e.anchor)})}function I(e,t){E.css({left:"+="+e+"px",top:"+="+t+"px"})}function q(){if(!E)return;E.css("visibility","hidden")}function R(e,t,n,r){if(!E)return;var i=r.x,s=r.y,o=b.width(),u=b.height(),a=jQuery(".shouts.remove");E.each(function(e,t){t=jQuery(t);var r=t.position(),f={visibility:"visible",left:r.left+(r.left-i)*(n-1),top:r.top+(r.top-s)*(n-1)};t.css(f)});if(a.length){E=E.not(a);a.remove()}}function U(){return;var e,t,n}var d,v=org.mymanatee.common.usng,m=new NDN({host:"localhost"}),g,y={},b,w=[],E,S='<div class="shout-box-wrapper"><div class="shout-box"><p class="shout" style="display:none;">$TEXT</p></div><i class="icon icon-shout-pin">,</i></div>';jQuery(window).on("resize load",function(){b||(b=jQuery("#myMap"));y=b.position()});var x=0,C=[],k,O={top:0,right:0,bottom:0,left:0},M="/",_="/",D,P;if("geolocation"in navigator)navigator.geolocation.getCurrentPosition(function(t){var n=P=t.coords;d=mapDebug=new e("myMap",{basemap:"streets",center:[n.longitude,n.latitude],zoom:12});l.autoRecenter(d);F(d)});else{d=new e("myMap",{basemap:"streets",center:[-79.4,43.55],zoom:9});l.autoRecenter(d)}var j={x:0,y:0},z=function(e){if(!demoRun){iterate(0);demoRun=!0}else{var t=W.val();if(!t)return;setTimeout(function(){W.val("")});var n={text:t,timeout:60,location:P,timestamp:(new Date).getTime()};A(n)}},W=jQuery("#shout").blur(z),X=jQuery(".shoutBox i").click(z)});