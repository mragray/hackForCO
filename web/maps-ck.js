var mapDebug;require(["esri/map","esri/geometry/Point","esri/geometry/Multipoint","esri/geometry/Polyline","esri/geometry/Polygon","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/InfoTemplate","./utils.js","dojo/_base/Color","dojo/on","dojo/dom","dojo/domReady!"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){"use strict";function S(e,n){var r=jQuery('<div class="popup" style="position:absolute; background:white; z-index:1000;"><span class="text">'+e.text+"</span></div>"),i=e.location,s=d.toScreen(new t(i.longitude,i.latitude));r.css({left:y.left+s.x,top:y.top+s.y});jQuery("body").prepend(r);E?E.add(r):E=jQuery(".popup");return}function x(e){var t=e.split(" "),n=t[2].split(""),r=t[3].split("");return t[0]+"/"+t[1]+"/"+n[0]+r[0]+"/"+n[1]+r[1]+"/"+n[2]+r[2]+"/"+n[3]+r[3]+"/"}function C(e){var t="Nei.ghbor.Net"+e+"shoutout",n=new Name(t),r=new Interest(n),i={};N=function(t,n,r,o){if(!t){setTimeout(function(){C(e)},250);return}var u=DataUtils.toString(r);u=JSON.parse(u);var a=u.text+u.timestamp;if(jQuery.inArray(a,w)>-1)return;w.push(a);console.log("added",a,"to",w);console.log(n,u,o);S(u);T.push(DataUtils.toNumbersFromString(o));console.log("exclusions",T);var f=new Name(n),l=new Interest(f);i.exclude=new Exclude(T);l.exclude=i.exclude;t.expressInterest(f,s,i)};var s=new ContentClosure(m,n,r,N);m.expressInterest(n,s,i)}function k(e){var t=O.split("/"),n="Nei.ghbor.Net";w.push(e.text+e.timestamp);S(e,!0);for(var r=0;r<6;r++){n=n+"/"+t[r];m[r]=new NDN({host:"localhost"});var i=new Name(n+"/shoutout"),s=new Name(n+"/shoutout/"+e.timestamp),o=m[r],u=new SignedInfo;u.freshnessSeconds=e.timeout;if(NDN.CSTable[r]==undefined)o.registerPrefix(i,new AsyncPutClosure(o,s,JSON.stringify(e),u));else{NDN.CSTable[r].closure.content=JSON.stringify(e);NDN.CSTable[r].closure.name=s}}}function D(e){L.left=e.xmin;L.right=e.xmax;L.top=e.ymax;L.bottom=e.ymin;var t=x(v.LLtoUSNG(L.top,L.left,4)).split("/"),n=x(v.LLtoUSNG(L.top,L.right,4)).split("/"),r=x(v.LLtoUSNG(L.bottom,L.left,4)).split("/"),i=x(v.LLtoUSNG(L.bottom,L.right,4)).split("/"),s=e.getCenter();_={latitude:s.y,longitude:s.x};M=v.LLtoUSNG(s.y,s.x,4);O=x(M);A="/";var o=0;while(t[o]==n[o]&&t[o]==r[o]&&t[o]==i[o]){A+=t[o]+"/";o++}C(A)}function P(e,t){var n={Lat:e.getLatitude().toFixed(2),Lon:e.getLongitude().toFixed(2)},r=new f("My Point","Latitude: ${Lat} <br/>Longitude: ${Lon}"),i=new s(e,pointSymbol,n,r);d.graphics.add(i)}function B(e){h(e,"extent-change",function(t,n,r,i){console.log("extent-change");D(e.geographicExtent)});h(e,"pan",function(e){var t=e.delta;j(t.x-H.x,t.y-H.y);H=t})}function j(e,t){console.log("moving",e,"by",t);E.css({left:"+="+e+"px",top:"+="+t+"px"})}var d,v=org.mymanatee.common.usng,m=new NDN({host:"localhost"}),g,y={},b,w=[],E;jQuery(window).on("resize load",function(){b||(b=jQuery("#myMap"));y=b.position()});var T=[],N,L={top:0,right:0,bottom:0,left:0},A="/",O="/",M,_;if("geolocation"in navigator)navigator.geolocation.getCurrentPosition(function(t){var n=_=t.coords;d=mapDebug=new e("myMap",{basemap:"streets",center:[n.longitude,n.latitude],zoom:12});l.autoRecenter(d);B(d)});else{d=new e("myMap",{basemap:"streets",center:[-79.4,43.55],zoom:9});l.autoRecenter(d)}var H={x:0,y:0},F=jQuery("#shout").blur(function(e){var t=F.val();if(!t)return;var n={text:t,timeout:60,location:_,timestamp:(new Date).getTime()};k(n)})});